<!-- AIGC:cursor|author:ä¹Œäº‘|lines:180|dates:2026-02 -->
<template>
  <view class="container">
    <view class="title">Vue3 å“åº”å¼åŸç†æ¼”ç¤º</view>
    <!-- 1. reactive -->
    <view class="section">
      <view class="section-title">1. reactive() æ¼”ç¤º</view>
      <view class="desc">reactive ç”¨äºåˆ›å»ºå“åº”å¼å¯¹è±¡ï¼Œæ”¯æŒæ·±å±‚å“åº”</view>
      <view class="demo-box">
        <view class="info">å§“åï¼š{{ state.user.name }}</view>
        <view class="info">å¹´é¾„ï¼š{{ state.user.age }}</view>
        <view class="info">åŸå¸‚ï¼š{{ state.user.address.city }}</view>
        <view class="btn-group">
          <button size="mini" @click="changeReactiveName">ä¿®æ”¹å§“å</button>
          <button size="mini" @click="changeReactiveAge">å¹´é¾„+1</button>
          <button size="mini" @click="changeReactiveCity">ä¿®æ”¹åŸå¸‚</button>
        </view>
      </view>
    </view>
    <!-- 2. ref -->
    <view class="section">
      <view class="section-title">2. ref() æ¼”ç¤º</view>
      <view class="desc">ref ç”¨äºåˆ›å»ºå“åº”å¼å¼•ç”¨ï¼Œå¯åŒ…è£…ä»»æ„ç±»å‹</view>
      <view class="demo-box">
        <view class="info">è®¡æ•°å™¨ï¼š{{ count }}</view>
        <view class="info">æ¶ˆæ¯ï¼š{{ message }}</view>
        <view class="btn-group">
          <button size="mini" @click="count++">count++</button>
          <button size="mini" @click="count--">count--</button>
          <button size="mini" @click="changeMessage">ä¿®æ”¹æ¶ˆæ¯</button>
        </view>
      </view>
    </view>
    <!-- 3. computed -->
    <view class="section">
      <view class="section-title">3. computed() æ¼”ç¤º</view>
      <view class="desc">computed åˆ›å»ºè®¡ç®—å±æ€§ï¼Œå…·æœ‰ç¼“å­˜ç‰¹æ€§</view>
      <view class="demo-box">
        <view class="info">firstNameï¼š{{ firstName }}</view>
        <view class="info">lastNameï¼š{{ lastName }}</view>
        <view class="info">fullNameï¼ˆè®¡ç®—å±æ€§ï¼‰ï¼š{{ fullName }}</view>
        <view class="info">è®¡ç®—æ¬¡æ•°ï¼š{{ computeCount }}</view>
        <view class="btn-group">
          <button size="mini" @click="changeFirstName">æ”¹å§“</button>
          <button size="mini" @click="changeLastName">æ”¹å</button>
          <button size="mini" @click="readFullName">è¯»å–fullName</button>
        </view>
      </view>
    </view>
    <!-- 4. watch -->
    <view class="section">
      <view class="section-title">4. watch() æ¼”ç¤º</view>
      <view class="desc">watch æ˜¾å¼ç›‘å¬æ•°æ®å˜åŒ–ï¼Œå¯è·å–æ–°æ—§å€¼</view>
      <view class="demo-box">
        <view class="info">ç›‘å¬å€¼ï¼š{{ watchValue }}</view>
        <view class="info">ç›‘å¬æ—¥å¿—ï¼š</view>
        <view class="log-box">
          <view v-for="(log, idx) in watchLogs" :key="idx" class="log-item">{{
            log
          }}</view>
        </view>
        <view class="btn-group">
          <button size="mini" @click="watchValue++">å€¼+1</button>
          <button size="mini" @click="watchValue += 10">å€¼+10</button>
          <button size="mini" @click="clearWatchLogs">æ¸…ç©ºæ—¥å¿—</button>
        </view>
      </view>
    </view>
    <!-- 5. watchEffect -->
    <view class="section">
      <view class="section-title">5. watchEffect() æ¼”ç¤º</view>
      <view class="desc">watchEffect è‡ªåŠ¨æ”¶é›†ä¾èµ–ï¼Œç«‹å³æ‰§è¡Œ</view>
      <view class="demo-box">
        <view class="info">æ•°å€¼Aï¼š{{ valueA }}</view>
        <view class="info">æ•°å€¼Bï¼š{{ valueB }}</view>
        <view class="info">watchEffect æ‰§è¡Œæ—¥å¿—ï¼š</view>
        <view class="log-box">
          <view v-for="(log, idx) in effectLogs" :key="idx" class="log-item">{{
            log
          }}</view>
        </view>
        <view class="btn-group">
          <button size="mini" @click="valueA++">A+1</button>
          <button size="mini" @click="valueB++">B+1</button>
          <button size="mini" @click="clearEffectLogs">æ¸…ç©ºæ—¥å¿—</button>
        </view>
      </view>
    </view>
    <!-- 6. toRefs -->
    <view class="section">
      <view class="section-title">6. toRefs() æ¼”ç¤º</view>
      <view class="desc">toRefs è§£å†³è§£æ„ä¸¢å¤±å“åº”å¼çš„é—®é¢˜</view>
      <view class="demo-box">
        <view class="info">åŸå§‹å¯¹è±¡ person.nameï¼š{{ person.name }}</view>
        <view class="info">è§£æ„å nameï¼š{{ personName }}</view>
        <view class="info">è§£æ„å ageï¼š{{ personAge }}</view>
        <view class="btn-group">
          <button size="mini" @click="personName = 'ç‹äº”'">
            ä¿®æ”¹è§£æ„çš„name
          </button>
          <button size="mini" @click="personAge++">è§£æ„çš„age+1</button>
          <button size="mini" @click="person.name = 'èµµå…­'">
            ä¿®æ”¹åŸå¯¹è±¡name
          </button>
        </view>
      </view>
    </view>
    <!-- 7. æ‰‹å†™å“åº”å¼ -->
    <view class="section">
      <view class="section-title">7. æ‰‹å†™å“åº”å¼åŸç†æ¼”ç¤º</view>
      <view class="desc">å±•ç¤ºä¾èµ–æ”¶é›†å’Œè§¦å‘æ›´æ–°çš„è¿‡ç¨‹</view>
      <view class="demo-box">
        <view class="info">æ‰‹å†™å“åº”å¼æ•°æ®ï¼š{{ customReactiveData }}</view>
        <view class="info">æ‰§è¡Œæ—¥å¿—ï¼š</view>
        <view class="log-box">
          <view v-for="(log, idx) in customLogs" :key="idx" class="log-item">{{
            log
          }}</view>
        </view>
        <view class="btn-group">
          <button size="mini" @click="runCustomReactive">è¿è¡Œæ¼”ç¤º</button>
          <button size="mini" @click="clearCustomLogs">æ¸…ç©ºæ—¥å¿—</button>
        </view>
      </view>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, reactive, computed, watch, watchEffect, toRefs } from 'vue'

// 1. reactive
const state = reactive({
  user: { name: 'å¼ ä¸‰', age: 20, address: { city: 'åŒ—äº¬' } },
})
const names = ['æå››', 'ç‹äº”', 'èµµå…­', 'å¼ ä¸‰']
let nameIdx = 0
const changeReactiveName = () => {
  state.user.name = names[nameIdx++ % names.length]!
}
const changeReactiveAge = () => {
  state.user.age++
}
const cities = ['ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'åŒ—äº¬']
let cityIdx = 0
const changeReactiveCity = () => {
  state.user.address.city = cities[cityIdx++ % cities.length]!
}

// 2. ref
const count = ref(0)
const message = ref('Hello Vue3!')
const msgs = ['ä½ å¥½ä¸–ç•Œï¼', 'Vue3 çœŸæ£’ï¼', 'å“åº”å¼åŸç†', 'Hello Vue3!']
let msgIdx = 0
const changeMessage = () => {
  message.value = msgs[msgIdx++ % msgs.length]!
}

// 3. computed
const firstName = ref('å¼ ')
const lastName = ref('ä¸‰')
const computeCount = ref(0)
const fullName = computed(() => {
  computeCount.value++
  return firstName.value + lastName.value
})
const fns = ['æ', 'ç‹', 'èµµ', 'å¼ ']
let fnIdx = 0
const changeFirstName = () => {
  firstName.value = fns[fnIdx++ % fns.length]!
}
const lns = ['å››', 'äº”', 'å…­', 'ä¸‰']
let lnIdx = 0
const changeLastName = () => {
  lastName.value = lns[lnIdx++ % lns.length]!
}
const readFullName = () => {
  console.log('è¯»å– fullName:', fullName.value)
}

// 4. watch
const watchValue = ref(0)
const watchLogs = ref<string[]>([])
watch(watchValue, (n, o) => {
  watchLogs.value.push(`å€¼å˜åŒ–: ${o} â†’ ${n}`)
})
const clearWatchLogs = () => {
  watchLogs.value = []
}

// 5. watchEffect
const valueA = ref(1)
const valueB = ref(100)
const effectLogs = ref<string[]>([])
watchEffect(() => {
  effectLogs.value.push(`watchEffect: A=${valueA.value}, B=${valueB.value}`)
})
const clearEffectLogs = () => {
  effectLogs.value = []
}

// 6. toRefs
const person = reactive({ name: 'å¼ ä¸‰', age: 20 })
const { name: personName, age: personAge } = toRefs(person)

// 7. æ‰‹å†™å“åº”å¼
const customReactiveData = ref('')
const customLogs = ref<string[]>([])
const addLog = (m: string) => {
  customLogs.value.push(m)
}
const runCustomReactive = () => {
  customLogs.value = []
  addLog('=== å¼€å§‹æ‰‹å†™å“åº”å¼æ¼”ç¤º ===')
  const targetMap = new WeakMap()
  let activeEffect: (() => void) | null = null
  const track = (t: object, k: string | symbol) => {
    if (!activeEffect) return
    let dm = targetMap.get(t)
    if (!dm) targetMap.set(t, (dm = new Map()))
    let d = dm.get(k)
    if (!d) dm.set(k, (d = new Set()))
    d.add(activeEffect)
    addLog(`ğŸ“¥ track: æ”¶é›†ä¾èµ– [${String(k)}]`)
  }
  const trigger = (t: object, k: string | symbol) => {
    const dm = targetMap.get(t)
    if (!dm) return
    const d = dm.get(k)
    if (!d) return
    addLog(`ğŸ“¤ trigger: è§¦å‘æ›´æ–° [${String(k)}]`)
    d.forEach((e: () => void) => e())
  }
  const myReactive = <T extends object>(t: T): T =>
    new Proxy(t, {
      get(target, key, receiver) {
        addLog(`ğŸ” get: [${String(key)}]`)
        track(target, key)
        return Reflect.get(target, key, receiver)
      },
      set(target, key, value, receiver) {
        addLog(`âœï¸ set: [${String(key)}]=${value}`)
        const res = Reflect.set(target, key, value, receiver)
        trigger(target, key)
        return res
      },
    })
  const myEffect = (fn: () => void) => {
    activeEffect = fn
    addLog('ğŸš€ effect æ‰§è¡Œ')
    fn()
    activeEffect = null
  }
  addLog('--- åˆ›å»ºå“åº”å¼å¯¹è±¡ ---')
  const data = myReactive({ count: 0 })
  addLog('--- æ³¨å†Œ effect ---')
  myEffect(() => {
    customReactiveData.value = `count = ${data.count}`
  })
  addLog('--- ä¿®æ”¹æ•°æ® count=1 ---')
  data.count = 1
  addLog('--- ä¿®æ”¹æ•°æ® count=2 ---')
  data.count = 2
  addLog('=== æ¼”ç¤ºç»“æŸ ===')
}
const clearCustomLogs = () => {
  customLogs.value = []
  customReactiveData.value = ''
}
</script>

<style scoped>
.container {
  padding: 20rpx;
  background-color: #f5f5f5;
  min-height: 100vh;
}
.title {
  font-size: 40rpx;
  font-weight: bold;
  text-align: center;
  padding: 30rpx 0;
  color: #333;
}
.section {
  background-color: #fff;
  border-radius: 16rpx;
  padding: 24rpx;
  margin-bottom: 24rpx;
  box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.1);
}
.section-title {
  font-size: 32rpx;
  font-weight: bold;
  color: #42b883;
  margin-bottom: 12rpx;
}
.desc {
  font-size: 24rpx;
  color: #999;
  margin-bottom: 20rpx;
}
.demo-box {
  background-color: #f9f9f9;
  border-radius: 12rpx;
  padding: 20rpx;
}
.info {
  font-size: 28rpx;
  color: #333;
  padding: 8rpx 0;
}
.btn-group {
  display: flex;
  flex-wrap: wrap;
  gap: 16rpx;
  margin-top: 20rpx;
}
.btn-group button {
  background-color: #42b883;
  color: #fff;
  border: none;
  font-size: 24rpx;
}
.log-box {
  background-color: #1e1e1e;
  border-radius: 8rpx;
  padding: 16rpx;
  margin-top: 12rpx;
  max-height: 300rpx;
  overflow-y: auto;
}
.log-item {
  font-size: 22rpx;
  color: #4ec9b0;
  font-family: monospace;
  line-height: 1.6;
}
</style>
